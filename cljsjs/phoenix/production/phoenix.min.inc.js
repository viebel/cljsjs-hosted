(function(l){function t(d){if(Array.isArray(d)){for(var a=0,b=Array(d.length);a<d.length;a++)b[a]=d[a];return b}return Array.from(d)}function m(d,a){if(!(d instanceof a))throw new TypeError("Cannot call a class as a function");}var u="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(d){return typeof d}:function(d){return d&&"function"===typeof Symbol&&d.constructor===Symbol?"symbol":typeof d},n=function(){function d(a,b){for(var c=0;c<b.length;c++){var e=b[c];e.enumerable=e.enumerable||
!1;e.configurable=!0;"value"in e&&(e.writable=!0);Object.defineProperty(a,e.key,e)}}return function(a,b,c){b&&d(a.prototype,b);c&&d(a,c);return a}}();Object.defineProperty(l,"__esModule",{value:!0});var q=function(){function d(a,b,c,e){m(this,d);this.channel=a;this.event=b;this.payload=c||{};this.receivedResp=null;this.timeout=e;this.timeoutTimer=null;this.recHooks=[];this.sent=!1}n(d,[{key:"resend",value:function(a){this.timeout=a;this.cancelRefEvent();this.receivedResp=this.refEvent=this.ref=null;
this.sent=!1;this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref}))}},{key:"receive",value:function(a,b){this.hasReceived(a)&&b(this.receivedResp.response);this.recHooks.push({status:a,callback:b});return this}},{key:"matchReceive",value:function(a){var b=a.status,c=a.response;this.recHooks.filter(function(a){return a.status===b}).forEach(function(a){return a.callback(c)})}},
{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer);this.timeoutTimer=null}},{key:"startTimeout",value:function(){var a=this;this.timeoutTimer||(this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,function(b){a.cancelRefEvent();a.cancelTimeout();a.receivedResp=b;a.matchReceive(b)}),this.timeoutTimer=setTimeout(function(){a.trigger("timeout",
{})},this.timeout))}},{key:"hasReceived",value:function(a){return this.receivedResp&&this.receivedResp.status===a}},{key:"trigger",value:function(a,b){this.channel.trigger(this.refEvent,{status:a,response:b})}}]);return d}(),v=l.Channel=function(){function d(a,b,c){var e=this;m(this,d);this.state="closed";this.topic=a;this.params=b||{};this.socket=c;this.bindings=[];this.timeout=this.socket.timeout;this.joinedOnce=!1;this.joinPush=new q(this,"phx_join",this.params,this.timeout);this.pushBuffer=[];
this.rejoinTimer=new r(function(){return e.rejoinUntilConnected()},this.socket.reconnectAfterMs);this.joinPush.receive("ok",function(){e.state="joined";e.rejoinTimer.reset();e.pushBuffer.forEach(function(a){return a.send()});e.pushBuffer=[]});this.onClose(function(){e.rejoinTimer.reset();e.socket.log("channel","close "+e.topic+" "+e.joinRef());e.state="closed";e.socket.remove(e)});this.onError(function(a){e.isLeaving()||e.isClosed()||(e.socket.log("channel","error "+e.topic,a),e.state="errored",e.rejoinTimer.scheduleTimeout())});
this.joinPush.receive("timeout",function(){e.isJoining()&&(e.socket.log("channel","timeout "+e.topic,e.joinPush.timeout),e.state="errored",e.rejoinTimer.scheduleTimeout())});this.on("phx_reply",function(a,b){e.trigger(e.replyEventName(b),a)})}n(d,[{key:"rejoinUntilConnected",value:function(){this.rejoinTimer.scheduleTimeout();this.socket.isConnected()&&this.rejoin()}},{key:"join",value:function(){var a=0>=arguments.length||void 0===arguments[0]?this.timeout:arguments[0];if(this.joinedOnce)throw"tried to join multiple times. 'join' can only be called a single time per channel instance";
this.joinedOnce=!0;this.rejoin(a);return this.joinPush}},{key:"onClose",value:function(a){this.on("phx_close",a)}},{key:"onError",value:function(a){this.on("phx_error",function(b){return a(b)})}},{key:"on",value:function(a,b){this.bindings.push({event:a,callback:b})}},{key:"off",value:function(a){this.bindings=this.bindings.filter(function(b){return b.event!==a})}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(a,b){var c=2>=arguments.length||
void 0===arguments[2]?this.timeout:arguments[2];if(!this.joinedOnce)throw"tried to push '"+a+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events";c=new q(this,a,b,c);this.canPush()?c.send():(c.startTimeout(),this.pushBuffer.push(c));return c}},{key:"leave",value:function(){var a=this,b=0>=arguments.length||void 0===arguments[0]?this.timeout:arguments[0];this.state="leaving";var c=function(){a.socket.log("channel","leave "+a.topic);a.trigger("phx_close","leave",a.joinRef())},
b=new q(this,"phx_leave",{},b);b.receive("ok",function(){return c()}).receive("timeout",function(){return c()});b.send();this.canPush()||b.trigger("ok",{});return b}},{key:"onMessage",value:function(a,b,c){return b}},{key:"isMember",value:function(a){return this.topic===a}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"sendJoin",value:function(a){this.state="joining";this.joinPush.resend(a)}},{key:"rejoin",value:function(){var a=0>=arguments.length||void 0===arguments[0]?this.timeout:
arguments[0];this.isLeaving()||this.sendJoin(a)}},{key:"trigger",value:function(a,b,c){if(!(c&&0<=["phx_close","phx_error","phx_leave","phx_join"].indexOf(a)&&c!==this.joinRef())){var e=this.onMessage(a,b,c);if(b&&!e)throw"channel onMessage callbacks must return the payload, modified or unmodified";this.bindings.filter(function(b){return b.event===a}).map(function(a){return a.callback(e,c)})}}},{key:"replyEventName",value:function(a){return"chan_reply_"+a}},{key:"isClosed",value:function(){return"closed"===
this.state}},{key:"isErrored",value:function(){return"errored"===this.state}},{key:"isJoined",value:function(){return"joined"===this.state}},{key:"isJoining",value:function(){return"joining"===this.state}},{key:"isLeaving",value:function(){return"leaving"===this.state}}]);return d}();l.Socket=function(){function d(a){var b=this,c=1>=arguments.length||void 0===arguments[1]?{}:arguments[1];m(this,d);this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.channels=[];this.sendBuffer=[];
this.ref=0;this.timeout=c.timeout||1E4;this.transport=c.transport||window.WebSocket||w;this.heartbeatIntervalMs=c.heartbeatIntervalMs||3E4;this.reconnectAfterMs=c.reconnectAfterMs||function(a){return[1E3,2E3,5E3,1E4][a-1]||1E4};this.logger=c.logger||function(){};this.longpollerTimeout=c.longpollerTimeout||2E4;this.params=c.params||{};this.endPoint=a+"/websocket";this.reconnectTimer=new r(function(){b.disconnect(function(){return b.connect()})},this.reconnectAfterMs)}n(d,[{key:"protocol",value:function(){return location.protocol.match(/^https/)?
"wss":"ws"}},{key:"endPointURL",value:function(){var a=p.appendParams(p.appendParams(this.endPoint,this.params),{vsn:"1.0.0"});return"/"!==a.charAt(0)?a:"/"===a.charAt(1)?this.protocol()+":"+a:this.protocol()+"://"+location.host+a}},{key:"disconnect",value:function(a,b,c){this.conn&&(this.conn.onclose=function(){},b?this.conn.close(b,c||""):this.conn.close(),this.conn=null);a&&a()}},{key:"connect",value:function(a){var b=this;a&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),
this.params=a);this.conn||(this.conn=new this.transport(this.endPointURL()),this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return b.onConnOpen()},this.conn.onerror=function(a){return b.onConnError(a)},this.conn.onmessage=function(a){return b.onConnMessage(a)},this.conn.onclose=function(a){return b.onConnClose(a)})}},{key:"log",value:function(a,b,c){this.logger(a,b,c)}},{key:"onOpen",value:function(a){this.stateChangeCallbacks.open.push(a)}},{key:"onClose",value:function(a){this.stateChangeCallbacks.close.push(a)}},
{key:"onError",value:function(a){this.stateChangeCallbacks.error.push(a)}},{key:"onMessage",value:function(a){this.stateChangeCallbacks.message.push(a)}},{key:"onConnOpen",value:function(){var a=this;this.log("transport","connected to "+this.endPointURL(),this.transport.prototype);this.flushSendBuffer();this.reconnectTimer.reset();this.conn.skipHeartbeat||(clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(function(){return a.sendHeartbeat()},this.heartbeatIntervalMs));this.stateChangeCallbacks.open.forEach(function(a){return a()})}},
{key:"onConnClose",value:function(a){this.log("transport","close",a);this.triggerChanError();clearInterval(this.heartbeatTimer);this.reconnectTimer.scheduleTimeout();this.stateChangeCallbacks.close.forEach(function(b){return b(a)})}},{key:"onConnError",value:function(a){this.log("transport",a);this.triggerChanError();this.stateChangeCallbacks.error.forEach(function(b){return b(a)})}},{key:"triggerChanError",value:function(){this.channels.forEach(function(a){return a.trigger("phx_error")})}},{key:"connectionState",
value:function(){switch(this.conn&&this.conn.readyState){case 0:return"connecting";case 1:return"open";case 2:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(a){this.channels=this.channels.filter(function(b){return b.joinRef()!==a.joinRef()})}},{key:"channel",value:function(a){var b=new v(a,1>=arguments.length||void 0===arguments[1]?{}:arguments[1],this);this.channels.push(b);return b}},{key:"push",
value:function(a){var b=this,c=function(){return b.conn.send(JSON.stringify(a))};this.log("push",a.topic+" "+a.event+" ("+a.ref+")",a.payload);this.isConnected()?c():this.sendBuffer.push(c)}},{key:"makeRef",value:function(){var a=this.ref+1;this.ref=a===this.ref?0:a;return this.ref.toString()}},{key:"sendHeartbeat",value:function(){this.isConnected()&&this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.makeRef()})}},{key:"flushSendBuffer",value:function(){this.isConnected()&&0<this.sendBuffer.length&&
(this.sendBuffer.forEach(function(a){return a()}),this.sendBuffer=[])}},{key:"onConnMessage",value:function(a){var b=JSON.parse(a.data),c=b.topic,e=b.event,d=b.payload,f=b.ref;this.log("receive",(d.status||"")+" "+c+" "+e+" "+(f&&"("+f+")"||""),d);this.channels.filter(function(a){return a.isMember(c)}).forEach(function(a){return a.trigger(e,d,f)});this.stateChangeCallbacks.message.forEach(function(a){return a(b)})}}]);return d}();var w=l.LongPoll=function(){function d(a){m(this,d);this.token=this.endPoint=
null;this.skipHeartbeat=!0;this.onopen=function(){};this.onerror=function(){};this.onmessage=function(){};this.onclose=function(){};this.pollEndpoint=this.normalizeEndpoint(a);this.readyState=0;this.poll()}n(d,[{key:"normalizeEndpoint",value:function(a){return a.replace("ws://","http://").replace("wss://","https://").replace(/(.*)\/websocket/,"$1/longpoll")}},{key:"endpointURL",value:function(){return p.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(){this.close();
this.readyState=0}},{key:"ontimeout",value:function(){this.onerror("timeout");this.closeAndRetry()}},{key:"poll",value:function(){var a=this;1!==this.readyState&&0!==this.readyState||p.request("GET",this.endpointURL(),"application/json",null,this.timeout,this.ontimeout.bind(this),function(b){if(b){var c=b.status,e=b.messages;a.token=b.token}else c=0;switch(c){case 200:e.forEach(function(b){return a.onmessage({data:JSON.stringify(b)})});a.poll();break;case 204:a.poll();break;case 410:a.readyState=
1;a.onopen();a.poll();break;case 0:case 500:a.onerror();a.closeAndRetry();break;default:throw"unhandled poll status "+c;}})}},{key:"send",value:function(a){var b=this;p.request("POST",this.endpointURL(),"application/json",a,this.timeout,this.onerror.bind(this,"timeout"),function(a){a&&200===a.status||(b.onerror(status),b.closeAndRetry())})}},{key:"close",value:function(a,b){this.readyState=3;this.onclose()}}]);return d}(),p=l.Ajax=function(){function d(){m(this,d)}n(d,null,[{key:"request",value:function(a,
b,c,e,d,f,h){if(window.XDomainRequest){var k=new XDomainRequest;this.xdomainRequest(k,a,b,e,d,f,h)}else k=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhrRequest(k,a,b,c,e,d,f,h)}},{key:"xdomainRequest",value:function(a,b,c,e,d,f,h){var k=this;a.timeout=d;a.open(b,c);a.onload=function(){var b=k.parseJSON(a.responseText);h&&h(b)};f&&(a.ontimeout=f);a.onprogress=function(){};a.send(e)}},{key:"xhrRequest",value:function(a,b,c,e,d,f,h,k){var s=this;a.timeout=f;
a.open(b,c,!0);a.setRequestHeader("Content-Type",e);a.onerror=function(){k&&k(null)};a.onreadystatechange=function(){if(a.readyState===s.states.complete&&k){var b=s.parseJSON(a.responseText);k(b)}};h&&(a.ontimeout=h);a.send(d)}},{key:"parseJSON",value:function(a){return a&&""!==a?JSON.parse(a):null}},{key:"serialize",value:function(a,b){var c=[],d;for(d in a)if(a.hasOwnProperty(d)){var g=b?b+"["+d+"]":d,f=a[d];"object"===("undefined"===typeof f?"undefined":u(f))?c.push(this.serialize(f,g)):c.push(encodeURIComponent(g)+
"\x3d"+encodeURIComponent(f))}return c.join("\x26")}},{key:"appendParams",value:function(a,b){if(0===Object.keys(b).length)return a;var c=a.match(/\?/)?"\x26":"?";return""+a+c+this.serialize(b)}}]);return d}();p.states={complete:4};l.Presence={syncState:function(d,a,b,c){var e=this,g=this.clone(d),f={},h={};this.map(g,function(b,c){a[b]||(h[b]=c)});this.map(a,function(a,b){var c=g[a];c?function(){var d=b.metas.map(function(a){return a.phx_ref}),g=c.metas.map(function(a){return a.phx_ref}),l=b.metas.filter(function(a){return 0>
g.indexOf(a.phx_ref)}),m=c.metas.filter(function(a){return 0>d.indexOf(a.phx_ref)});0<l.length&&(f[a]=b,f[a].metas=l);0<m.length&&(h[a]=e.clone(c),h[a].metas=m)}():f[a]=b});return this.syncDiff(g,{joins:f,leaves:h},b,c)},syncDiff:function(d,a,b,c){var e=a.joins;a=a.leaves;var g=this.clone(d);b||(b=function(){});c||(c=function(){});this.map(e,function(a,c){var d=g[a];g[a]=c;if(d){var e;(e=g[a].metas).unshift.apply(e,t(d.metas))}b(a,d,c)});this.map(a,function(a,b){var d=g[a];if(d){var e=b.metas.map(function(a){return a.phx_ref});
d.metas=d.metas.filter(function(a){return 0>e.indexOf(a.phx_ref)});c(a,d,b);0===d.metas.length&&delete g[a]}});return g},list:function(d,a){a||(a=function(a,c){return c});return this.map(d,function(b,c){return a(b,c)})},map:function(d,a){return Object.getOwnPropertyNames(d).map(function(b){return a(b,d[b])})},clone:function(d){return JSON.parse(JSON.stringify(d))}};var r=function(){function d(a,b){m(this,d);this.callback=a;this.timerCalc=b;this.timer=null;this.tries=0}n(d,[{key:"reset",value:function(){this.tries=
0;clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var a=this;clearTimeout(this.timer);this.timer=setTimeout(function(){a.tries+=1;a.callback()},this.timerCalc(this.tries+1))}}]);return d}()})("undefined"===typeof exports?window.Phoenix=window.Phoenix||{}:exports);