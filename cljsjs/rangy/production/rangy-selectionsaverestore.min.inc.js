(function(h,g){"function"==typeof define&&define.amd?define(["./rangy-core"],h):"undefined"!=typeof module&&"object"==typeof exports?module.exports=h(require("rangy")):h(g.rangy)})(function(h){h.createModule("SaveRestore",["WrappedRange"],function(g,h){function m(a,e){var b="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),c,d=n.getDocument(a.startContainer),f=a.cloneRange();f.collapse(e);c=d.createElement("span");c.id=b;c.style.lineHeight="0";c.style.display="none";c.className="rangySelectionBoundary";
c.appendChild(d.createTextNode("ï»¿"));f.insertNode(c);return c}function p(a,e,b,c){(a=(a||document).getElementById(b))?(e[c?"setStartBefore":"setEndBefore"](a),k(a)):h.warn("Marker element has been removed. Cannot restore selection.")}function v(a,e){return e.compareBoundaryPoints(a.START_TO_START,a)}function q(a,e){var b,c,d=g.DomRange.getRangeDocument(a),f=a.toString(),h=r(e);if(a.collapsed)return c=m(a,!1),{document:d,markerId:c.id,collapsed:!0};c=m(a,!1);b=m(a,!0);return{document:d,startMarkerId:b.id,
endMarkerId:c.id,collapsed:!1,backward:h,toString:function(){return"original text: '"+f+"', new text: '"+a.toString()+"'"}}}function s(a,e){var b=a.document;"undefined"==typeof e&&(e=!0);var c=g.createRange(b);if(a.collapsed)if(b=(b||document).getElementById(a.markerId)){b.style.display="inline";var d=b.previousSibling;d&&3==d.nodeType?(k(b),c.collapseToPoint(d,d.length)):(c.collapseBefore(b),k(b))}else h.warn("Marker element has been removed. Cannot restore selection.");else p(b,c,a.startMarkerId,
!0),p(b,c,a.endMarkerId,!1);e&&c.normalizeBoundaries();return c}function t(a,e){var b=[],c,d;c=r(e);a=a.slice(0);a.sort(v);var f=0;for(d=a.length;f<d;++f)b[f]=q(a[f],c);for(f=d-1;0<=f;--f)c=a[f],d=g.DomRange.getRangeDocument(c),c.collapsed?c.collapseAfter((d||document).getElementById(b[f].markerId)):(c.setEndBefore((d||document).getElementById(b[f].endMarkerId)),c.setStartAfter((d||document).getElementById(b[f].startMarkerId)));return b}function u(a){for(var e=[],b=a.length-1;0<=b;b--)e[b]=s(a[b],
!0);return e}function l(a,e){var b=(a||document).getElementById(e);b&&k(b)}var n=g.dom,k=n.removeNode,r=g.Selection.isDirectionBackward;g.util.extend(g,{saveRange:q,restoreRange:s,saveRanges:t,restoreRanges:u,saveSelection:function(a){if(!g.isSelectionValid(a))return h.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var e=g.getSelection(a),b=e.getAllRanges(),c=1==b.length&&e.isBackward(),d=t(b,c);c?e.setSingleRange(b[0],
c):e.setRanges(b);return{win:a,rangeInfos:d,restored:!1}},restoreSelection:function(a,e){if(!a.restored){var b=a.rangeInfos,c=g.getSelection(a.win),d=u(b);1==b.length&&e&&g.features.selectionHasExtend&&b[0].backward?(c.removeAllRanges(),c.addRange(d[0],!0)):c.setRanges(d);a.restored=!0}},removeMarkerElement:l,removeMarkers:function(a){for(var e=a.rangeInfos,b=0,c=e.length,d;b<c;++b)d=e[b],d.collapsed?l(a.doc,d.markerId):(l(a.doc,d.startMarkerId),l(a.doc,d.endMarkerId))}})});return h},this);