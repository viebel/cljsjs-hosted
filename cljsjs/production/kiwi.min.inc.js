(function(l,u){"object"===typeof exports&&"undefined"!==typeof module?u(exports):"function"===typeof define&&define.amd?define(["exports"],u):u(l.kiwi={})})(this,function(l){function u(a){for(var b=0,e=function(){return 0},c=new p,d=0,g=a.length;d<g;++d){var f=a[d];if("number"===typeof f)b+=f;else if(f instanceof w)c.setDefault(f,e).second+=1;else if(f instanceof m)for(var b=b+f.constant(),f=f.terms(),k=0,h=f.size();k<h;k++){var l=f.itemAt(k);c.setDefault(l.first,e).second+=l.second}else if(f instanceof
Array){if(2!==f.length)throw Error("array must have length 2");var q=f[0],f=f[1];if("number"!==typeof q)throw Error("array item 0 must be a number");if(f instanceof w)c.setDefault(f,e).second+=q;else if(f instanceof m)for(b+=f.constant()*q,f=f.terms(),k=0,h=f.size();k<h;k++)l=f.itemAt(k),c.setDefault(l.first,e).second+=l.second*q;else throw Error("array item 1 must be a variable or expression");}else throw Error("invalid Expression argument: "+f);}return{terms:c,constant:b}}function v(a){return 0>
a?1E-8>-a:1E-8>a}var p=function(){function a(){this.index={};this.array=[]}a.prototype.size=function(){return this.array.length};a.prototype.empty=function(){return 0===this.array.length};a.prototype.itemAt=function(b){return this.array[b]};a.prototype.contains=function(b){return void 0!==this.index[b.id()]};a.prototype.find=function(b){b=this.index[b.id()];return void 0===b?void 0:this.array[b]};a.prototype.setDefault=function(b,e){var a=this.index[b.id()];return void 0===a?(a=new y(b,e()),this.index[b.id()]=
this.array.length,this.array.push(a),a):this.array[a]};a.prototype.insert=function(b,e){var a=new y(b,e),d=this.index[b.id()];void 0===d?(this.index[b.id()]=this.array.length,this.array.push(a)):this.array[d]=a;return a};a.prototype.erase=function(b){var e=this.index[b.id()];if(void 0!==e){this.index[b.id()]=void 0;b=this.array[e];var a=this.array.pop();b!==a&&(this.array[e]=a,this.index[a.first.id()]=e);return b}};a.prototype.copy=function(){for(var b=new a,e=0;e<this.array.length;e++){var c=this.array[e].copy();
b.array[e]=c;b.index[c.first.id()]=e}return b};return a}(),y=function(){function a(b,e){this.first=b;this.second=e}a.prototype.copy=function(){return new a(this.first,this.second)};return a}(),w=function(){function a(b){void 0===b&&(b="");this._value=0;this._context=null;this._id=B++;this._name=b}a.Compare=function(b,e){return b.id()-e.id()};a.prototype.id=function(){return this._id};a.prototype.name=function(){return this._name};a.prototype.setName=function(b){this._name=b};a.prototype.context=function(){return this._context};
a.prototype.setContext=function(b){this._context=b};a.prototype.value=function(){return this._value};a.prototype.setValue=function(b){this._value=b};a.prototype.plus=function(b){return new m(this,b)};a.prototype.minus=function(b){return new m(this,"number"===typeof b?-b:[-1,b])};a.prototype.multiply=function(b){return new m([b,this])};a.prototype.divide=function(b){return new m([1/b,this])};a.prototype.toJSON=function(){return{name:this._name,value:this._value}};a.prototype.toString=function(){return this._context+
"["+this._name+":"+this._value+"]"};return a}(),B=0,m=function(){function a(){var b=u(arguments);this._terms=b.terms;this._constant=b.constant}a.prototype.terms=function(){return this._terms};a.prototype.constant=function(){return this._constant};a.prototype.value=function(){for(var b=this._constant,e=0,a=this._terms.size();e<a;e++)var d=this._terms.itemAt(e),b=b+d.first.value()*d.second;return b};a.prototype.plus=function(b){return new a(this,b)};a.prototype.minus=function(b){return new a(this,"number"===
typeof b?-b:[-1,b])};a.prototype.multiply=function(b){return new a([b,this])};a.prototype.divide=function(b){return new a([1/b,this])};a.prototype.isConstant=function(){return 0==this._terms.size()};a.prototype.toString=function(){var b=this._terms.array.map(function(b,a){return b.second+"*"+b.first.toString()}).join(" + ");this.isConstant()||0===this._constant||(b+=" + ");return b+=this._constant};return a}(),n=function(){function a(){}a.create=function(b,a,c,d){void 0===d&&(d=1);b=0+1E6*Math.max(0,
Math.min(1E3,b*d));b+=1E3*Math.max(0,Math.min(1E3,a*d));return b+=Math.max(0,Math.min(1E3,c*d))};a.clip=function(b){return Math.max(0,Math.min(a.required,b))};a.required=a.create(1E3,1E3,1E3);a.strong=a.create(1,0,0);a.medium=a.create(0,1,0);a.weak=a.create(0,0,1);return a}();(function(a){a[a.Le=0]="Le";a[a.Ge=1]="Ge";a[a.Eq=2]="Eq"})(l.Operator||(l.Operator={}));var x=function(){function a(b,a,c,d){void 0===d&&(d=n.required);this._id=C++;this._operator=a;this._strength=n.clip(d);this._expression=
void 0===c&&b instanceof m?b:b.minus(c)}a.Compare=function(b,a){return b.id()-a.id()};a.prototype.id=function(){return this._id};a.prototype.expression=function(){return this._expression};a.prototype.op=function(){return this._operator};a.prototype.strength=function(){return this._strength};a.prototype.toString=function(){return this._expression.toString()+" "+["\x3c\x3d","\x3e\x3d","\x3d"][this._operator]+" 0 ("+this._strength.toString()+")"};return a}(),C=0,D=function(){function a(){this._cnMap=
new p;this._rowMap=new p;this._varMap=new p;this._editMap=new p;this._infeasibleRows=[];this._objective=new z;this._artificial=null;this._idTick=0}a.prototype.createConstraint=function(b,a,c,d){void 0===d&&(d=n.required);b=new x(b,a,c,d);this.addConstraint(b);return b};a.prototype.addConstraint=function(b){if(void 0!==this._cnMap.find(b))throw Error("duplicate constraint");var a=this._createRow(b),c=a.row,a=a.tag,d=this._chooseSubject(c,a);if(d.type()===h.Invalid&&c.allDummies())if(v(c.constant()))d=
a.marker;else throw Error("unsatisfiable constraint");if(d.type()===h.Invalid){if(!this._addWithArtificialVariable(c))throw Error("unsatisfiable constraint");}else c.solveFor(d),this._substitute(d,c),this._rowMap.insert(d,c);this._cnMap.insert(b,a);this._optimize(this._objective)};a.prototype.removeConstraint=function(b){var a=this._cnMap.erase(b);if(void 0===a)throw Error("unknown constraint");this._removeConstraintEffects(b,a.second);b=a.second.marker;a=this._rowMap.erase(b);if(void 0===a){var c=
this._getMarkerLeavingSymbol(b);if(c.type()===h.Invalid)throw Error("failed to find leaving row");a=this._rowMap.erase(c);a.second.solveForEx(c,b);this._substitute(b,a.second)}this._optimize(this._objective)};a.prototype.hasConstraint=function(b){return this._cnMap.contains(b)};a.prototype.addEditVariable=function(b,a){if(void 0!==this._editMap.find(b))throw Error("duplicate edit variable");a=n.clip(a);if(a===n.required)throw Error("bad required strength");var c=new m(b),c=new x(c,l.Operator.Eq,void 0,
a);this.addConstraint(c);c={tag:this._cnMap.find(c).second,constraint:c,constant:0};this._editMap.insert(b,c)};a.prototype.removeEditVariable=function(b){b=this._editMap.erase(b);if(void 0===b)throw Error("unknown edit variable");this.removeConstraint(b.second.constraint)};a.prototype.hasEditVariable=function(b){return this._editMap.contains(b)};a.prototype.suggestValue=function(b,a){var c=this._editMap.find(b);if(void 0===c)throw Error("unknown edit variable");var d=this._rowMap,g=c.second,c=a-g.constant;
g.constant=a;var f=g.tag.marker,k=d.find(f);if(void 0!==k)0>k.second.add(-c)&&this._infeasibleRows.push(f);else if(g=g.tag.other,k=d.find(g),void 0!==k)0>k.second.add(c)&&this._infeasibleRows.push(g);else for(k=0,g=d.size();k<g;++k){var l=d.itemAt(k),m=l.second,q=m.coefficientFor(f);0!==q&&0>m.add(c*q)&&l.first.type()!==h.External&&this._infeasibleRows.push(l.first)}this._dualOptimize()};a.prototype.updateVariables=function(){for(var b=this._varMap,a=this._rowMap,c=0,d=b.size();c<d;++c){var g=b.itemAt(c),
f=a.find(g.second);void 0!==f?g.first.setValue(f.second.constant()):g.first.setValue(0)}};a.prototype._getVarSymbol=function(b){var a=this;return this._varMap.setDefault(b,function(){return a._makeSymbol(h.External)}).second};a.prototype._createRow=function(b){for(var a=b.expression(),c=new z(a.constant()),a=a.terms(),d=0,g=a.size();d<g;++d){var f=a.itemAt(d);if(!v(f.second)){var k=this._getVarSymbol(f.first),m=this._rowMap.find(k);void 0!==m?c.insertRow(m.second,f.second):c.insertSymbol(k,f.second)}}d=
this._objective;g=b.strength();a={marker:t,other:t};switch(b.op()){case l.Operator.Le:case l.Operator.Ge:b=b.op()===l.Operator.Le?1:-1;f=this._makeSymbol(h.Slack);a.marker=f;c.insertSymbol(f,b);g<n.required&&(f=this._makeSymbol(h.Error),a.other=f,c.insertSymbol(f,-b),d.insertSymbol(f,g));break;case l.Operator.Eq:g<n.required?(b=this._makeSymbol(h.Error),f=this._makeSymbol(h.Error),a.marker=b,a.other=f,c.insertSymbol(b,-1),c.insertSymbol(f,1),d.insertSymbol(b,g),d.insertSymbol(f,g)):(b=this._makeSymbol(h.Dummy),
a.marker=b,c.insertSymbol(b))}0>c.constant()&&c.reverseSign();return{row:c,tag:a}};a.prototype._chooseSubject=function(b,a){for(var c=b.cells(),d=0,g=c.size();d<g;++d){var f=c.itemAt(d);if(f.first.type()===h.External)return f.first}c=a.marker.type();if((c===h.Slack||c===h.Error)&&0>b.coefficientFor(a.marker))return a.marker;c=a.other.type();return(c===h.Slack||c===h.Error)&&0>b.coefficientFor(a.other)?a.other:t};a.prototype._addWithArtificialVariable=function(b){var a=this._makeSymbol(h.Slack);this._rowMap.insert(a,
b.copy());this._artificial=b.copy();this._optimize(this._artificial);b=v(this._artificial.constant());this._artificial=null;var c=this._rowMap.erase(a);if(void 0!==c){c=c.second;if(c.isConstant())return b;var d=this._anyPivotableSymbol(c);if(d.type()===h.Invalid)return!1;c.solveForEx(a,d);this._substitute(d,c);this._rowMap.insert(d,c)}for(var c=this._rowMap,d=0,g=c.size();d<g;++d)c.itemAt(d).second.removeSymbol(a);this._objective.removeSymbol(a);return b};a.prototype._substitute=function(b,a){for(var c=
this._rowMap,d=0,g=c.size();d<g;++d){var f=c.itemAt(d);f.second.substitute(b,a);0>f.second.constant()&&f.first.type()!==h.External&&this._infeasibleRows.push(f.first)}this._objective.substitute(b,a);this._artificial&&this._artificial.substitute(b,a)};a.prototype._optimize=function(b){for(;;){var a=this._getEnteringSymbol(b);if(a.type()===h.Invalid)break;var c=this._getLeavingSymbol(a);if(c.type()===h.Invalid)throw Error("the objective is unbounded");var d=this._rowMap.erase(c).second;d.solveForEx(c,
a);this._substitute(a,d);this._rowMap.insert(a,d)}};a.prototype._dualOptimize=function(){for(var b=this._rowMap,a=this._infeasibleRows;0!==a.length;){var c=a.pop(),d=b.find(c);if(void 0!==d&&0>d.second.constant()){var g=this._getDualEnteringSymbol(d.second);if(g.type()===h.Invalid)throw Error("dual optimize failed");d=d.second;b.erase(c);d.solveForEx(c,g);this._substitute(g,d);b.insert(g,d)}}};a.prototype._getEnteringSymbol=function(b){b=b.cells();for(var a=0,c=b.size();a<c;++a){var d=b.itemAt(a),
g=d.first;if(0>d.second&&g.type()!==h.Dummy)return g}return t};a.prototype._getDualEnteringSymbol=function(b){var a=Number.MAX_VALUE,c=t;b=b.cells();for(var d=0,g=b.size();d<g;++d){var f=b.itemAt(d),k=f.first,f=f.second;0<f&&k.type()!==h.Dummy&&(f=this._objective.coefficientFor(k)/f,f<a&&(a=f,c=k))}return c};a.prototype._getLeavingSymbol=function(a){for(var e=Number.MAX_VALUE,c=t,d=this._rowMap,g=0,f=d.size();g<f;++g){var k=d.itemAt(g),l=k.first;if(l.type()!==h.External){var k=k.second,m=k.coefficientFor(a);
0>m&&(k=-k.constant()/m,k<e&&(e=k,c=l))}}return c};a.prototype._getMarkerLeavingSymbol=function(a){for(var e=Number.MAX_VALUE,c=e,d=t,g=d,f=d,k=d,l=this._rowMap,m=0,q=l.size();m<q;++m){var n=l.itemAt(m),r=n.second,p=r.coefficientFor(a);0!==p&&(n=n.first,n.type()===h.External?k=n:0>p?(r=-r.constant()/p,r<c&&(c=r,g=n)):(r=r.constant()/p,r<e&&(e=r,f=n)))}return g!==d?g:f!==d?f:k};a.prototype._removeConstraintEffects=function(a,e){e.marker.type()===h.Error&&this._removeMarkerEffects(e.marker,a.strength());
e.other.type()===h.Error&&this._removeMarkerEffects(e.other,a.strength())};a.prototype._removeMarkerEffects=function(a,e){var c=this._rowMap.find(a);void 0!==c?this._objective.insertRow(c.second,-e):this._objective.insertSymbol(a,-e)};a.prototype._anyPivotableSymbol=function(a){a=a.cells();for(var e=0,c=a.size();e<c;++e){var d=a.itemAt(e),g=d.first.type();if(g===h.Slack||g===h.Error)return d.first}return t};a.prototype._makeSymbol=function(a){return new A(a,this._idTick++)};return a}(),h;(function(a){a[a.Invalid=
0]="Invalid";a[a.External=1]="External";a[a.Slack=2]="Slack";a[a.Error=3]="Error";a[a.Dummy=4]="Dummy"})(h||(h={}));var A=function(){function a(a,e){this._id=e;this._type=a}a.Compare=function(a,e){return a.id()-e.id()};a.prototype.id=function(){return this._id};a.prototype.type=function(){return this._type};return a}(),t=new A(h.Invalid,-1),z=function(){function a(a){void 0===a&&(a=0);this._cellMap=new p;this._constant=a}a.prototype.cells=function(){return this._cellMap};a.prototype.constant=function(){return this._constant};
a.prototype.isConstant=function(){return this._cellMap.empty()};a.prototype.allDummies=function(){for(var a=this._cellMap,e=0,c=a.size();e<c;++e)if(a.itemAt(e).first.type()!==h.Dummy)return!1;return!0};a.prototype.copy=function(){var b=new a(this._constant);b._cellMap=this._cellMap.copy();return b};a.prototype.add=function(a){return this._constant+=a};a.prototype.insertSymbol=function(a,e){void 0===e&&(e=1);var c=this._cellMap.setDefault(a,function(){return 0});v(c.second+=e)&&this._cellMap.erase(a)};
a.prototype.insertRow=function(a,e){void 0===e&&(e=1);this._constant+=a._constant*e;for(var c=a._cellMap,d=0,g=c.size();d<g;++d){var f=c.itemAt(d);this.insertSymbol(f.first,f.second*e)}};a.prototype.removeSymbol=function(a){this._cellMap.erase(a)};a.prototype.reverseSign=function(){this._constant=-this._constant;for(var a=this._cellMap,e=0,c=a.size();e<c;++e){var d=a.itemAt(e);d.second=-d.second}};a.prototype.solveFor=function(a){var e=this._cellMap;a=-1/e.erase(a).second;this._constant*=a;for(var c=
0,d=e.size();c<d;++c)e.itemAt(c).second*=a};a.prototype.solveForEx=function(a,e){this.insertSymbol(a,-1);this.solveFor(e)};a.prototype.coefficientFor=function(a){a=this._cellMap.find(a);return void 0!==a?a.second:0};a.prototype.substitute=function(a,e){var c=this._cellMap.erase(a);void 0!==c&&this.insertRow(e,c.second)};return a}();l.Constraint=x;l.Expression=m;l.Solver=D;l.Strength=n;l.Variable=w;Object.defineProperty(l,"__esModule",{value:!0})});