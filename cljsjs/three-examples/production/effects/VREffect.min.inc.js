THREE.VREffect=function(b,E){var q,t,u,v,w,x,y,z;function P(a){F=a;0<a.length?c=a[0]:E&&E("HMD not available")}function G(){var a=m.isPresenting;m.isPresenting=void 0!==c&&c.isPresenting;if(m.isPresenting){var d=c.getEyeParameters("left"),e=d.renderWidth,d=d.renderHeight;a||(r=b.getPixelRatio(),p=b.getSize(),b.setPixelRatio(1),b.setSize(2*e,d,!1))}else a&&(b.setPixelRatio(r),b.setSize(p.width,p.height,H))}function I(a,d,e,b){var c,f=Math.PI/180;c=Math.tan(a.upDegrees*f);var g=Math.tan(a.downDegrees*
f),h=Math.tan(a.leftDegrees*f);a=Math.tan(a.rightDegrees*f);e=void 0===e?.01:e;b=void 0===b?1E4:b;var f=void 0===d||d?-1:1,k=new THREE.Matrix4,l=k.elements,m=2/(h+a),q=2/(c+g);d=[m,q];c=[(h-a)*m*.5,(c-g)*q*.5];l[0]=d[0];l[1]=0;l[2]=c[0]*f;l[3]=0;l[4]=0;l[5]=d[1];l[6]=-c[1]*f;l[7]=0;l[8]=0;l[9]=0;l[10]=b/(e-b)*-f;l[11]=b*e/(e-b);l[12]=0;l[13]=0;l[14]=f;l[15]=0;k.transpose();return k}var c,F,J=new THREE.Vector3,K=new THREE.Vector3,A=new THREE.Matrix4,B=new THREE.Matrix4,C=new THREE.Matrix4,D=null;"VRFrameData"in
window&&(D=new window.VRFrameData);navigator.getVRDisplays&&navigator.getVRDisplays().then(P).catch(function(){console.warn("THREE.VREffect: Unable to get VR Displays")});this.isPresenting=!1;var m=this,p=b.getSize(),H=!1,r=b.getPixelRatio();this.getVRDisplay=function(){return c};this.setVRDisplay=function(a){c=a};this.getVRDisplays=function(){console.warn("THREE.VREffect: getVRDisplays() is being deprecated.");return F};this.setSize=function(a,d,e){p={width:a,height:d};H=e;m.isPresenting?(a=c.getEyeParameters("left"),
b.setPixelRatio(1),b.setSize(2*a.renderWidth,a.renderHeight,!1)):(b.setPixelRatio(r),b.setSize(a,d,e))};var Q=b.domElement,L=[0,0,.5,1],M=[.5,0,.5,1];window.addEventListener("vrdisplaypresentchange",G,!1);this.setFullScreen=function(a){return new Promise(function(b,e){void 0===c?e(Error("No VR hardware found.")):m.isPresenting===a?b():a?b(c.requestPresent([{source:Q}])):b(c.exitPresent())})};this.requestPresent=function(){return this.setFullScreen(!0)};this.exitPresent=function(){return this.setFullScreen(!1)};
this.requestAnimationFrame=function(a){return void 0!==c?c.requestAnimationFrame(a):window.requestAnimationFrame(a)};this.cancelAnimationFrame=function(a){void 0!==c?c.cancelAnimationFrame(a):window.cancelAnimationFrame(a)};this.submitFrame=function(){void 0!==c&&m.isPresenting&&c.submitFrame()};this.autoSubmitFrame=!0;var g=new THREE.PerspectiveCamera;g.layers.enable(1);var k=new THREE.PerspectiveCamera;k.layers.enable(2);this.render=function(a,d,e,p){if(c&&m.isPresenting){var r=a.autoUpdate;r&&
(a.updateMatrixWorld(),a.autoUpdate=!1);Array.isArray(a)&&(console.warn("THREE.VREffect.render() no longer supports arrays. Use object.layers instead."),a=a[0]);var f=b.getSize(),n=c.getLayers(),h;n.length?(h=n[0],n=null!==h.leftBounds&&4===h.leftBounds.length?h.leftBounds:L,h=null!==h.rightBounds&&4===h.rightBounds.length?h.rightBounds:M):(n=L,h=M);w=Math.round(f.width*n[0]);x=Math.round(f.height*n[1]);y=Math.round(f.width*n[2]);z=Math.round(f.height*n[3]);q=Math.round(f.width*h[0]);t=Math.round(f.height*
h[1]);u=Math.round(f.width*h[2]);v=Math.round(f.height*h[3]);e?(b.setRenderTarget(e),e.scissorTest=!0):(b.setRenderTarget(null),b.setScissorTest(!0));(b.autoClear||p)&&b.clear();null===d.parent&&d.updateMatrixWorld();d.matrixWorld.decompose(g.position,g.quaternion,g.scale);k.position.copy(g.position);k.quaternion.copy(g.quaternion);k.scale.copy(g.scale);c.getFrameData?(c.depthNear=d.near,c.depthFar=d.far,c.getFrameData(D),g.projectionMatrix.elements=D.leftProjectionMatrix,k.projectionMatrix.elements=
D.rightProjectionMatrix,d=D,d.pose.orientation?(N.fromArray(d.pose.orientation),A.makeRotationFromQuaternion(N)):A.identity(),d.pose.position&&(O.fromArray(d.pose.position),A.setPosition(O)),B.fromArray(d.leftViewMatrix),B.multiply(A),C.fromArray(d.rightViewMatrix),C.multiply(A),B.getInverse(B),C.getInverse(C),g.updateMatrix(),g.matrix.multiply(B),g.matrix.decompose(g.position,g.quaternion,g.scale),k.updateMatrix(),k.matrix.multiply(C),k.matrix.decompose(k.position,k.quaternion,k.scale)):(n=c.getEyeParameters("left"),
h=c.getEyeParameters("right"),g.projectionMatrix=I(n.fieldOfView,!0,d.near,d.far),k.projectionMatrix=I(h.fieldOfView,!0,d.near,d.far),J.fromArray(n.offset),K.fromArray(h.offset),g.translateOnAxis(J,g.scale.x),k.translateOnAxis(K,k.scale.x));e?(e.viewport.set(w,x,y,z),e.scissor.set(w,x,y,z)):(b.setViewport(w,x,y,z),b.setScissor(w,x,y,z));b.render(a,g,e,p);e?(e.viewport.set(q,t,u,v),e.scissor.set(q,t,u,v)):(b.setViewport(q,t,u,v),b.setScissor(q,t,u,v));b.render(a,k,e,p);e?(e.viewport.set(0,0,f.width,
f.height),e.scissor.set(0,0,f.width,f.height),e.scissorTest=!1,b.setRenderTarget(null)):(b.setViewport(0,0,f.width,f.height),b.setScissorTest(!1));r&&(a.autoUpdate=!0);m.autoSubmitFrame&&m.submitFrame()}else b.render(a,d,e,p)};this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",G,!1)};var N=new THREE.Quaternion,O=new THREE.Vector3};