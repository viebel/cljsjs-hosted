(function(h,n){"object"===typeof exports&&"undefined"!==typeof module?module.exports=n():"function"===typeof define&&define.amd?define(n):(h.THREE=h.THREE||{},h.THREE.XLoader=n())})(this,function(){var h=function(h,l){if(!(h instanceof l))throw new TypeError("Cannot call a class as a function");},n=function(){function h(l,k){for(var e=0;e<k.length;e++){var a=k[e];a.enumerable=a.enumerable||!1;a.configurable=!0;"value"in a&&(a.writable=!0);Object.defineProperty(l,a.key,a)}}return function(l,k,e){k&&
h(l.prototype,k);e&&h(l,e);return l}}(),p=function l(){h(this,l);this.boneName="";this.BoneIndex=0;this.Indeces=[];this.Weights=[];this.OffsetMatrix=this.initMatrix=null},q=function k(){h(this,k);this.boneName=this.animeName="";this.targetBone=null;this.keyType=4;this.frameStartLv=0;this.keyFrames=[];this.InverseMx=null},r=function(){function k(e){h(this,k);this.fps=30;this.name="xanimation";this.length=0;this.hierarchy=[];this.putFlags=e;void 0===this.putFlags.putPos&&(this.putFlags.putPos=!0);void 0===
this.putFlags.putRot&&(this.putFlags.putRot=!0);void 0===this.putFlags.putScl&&(this.putFlags.putScl=!0)}n(k,[{key:"make",value:function(e){for(var a=0;a<e.length;a++)this.hierarchy.push(this.makeBonekeys(e[a]));this.length=this.hierarchy[0].keys[this.hierarchy[0].keys.length-1].time}},{key:"clone",value:function(){return Object.assign({},this)}},{key:"makeBonekeys",value:function(e){var a={};a.name=e.boneName;a.parent="";a.keys=this.keyFrameRefactor(e);a.copy=function(){return Object.assign({},this)};
return a}},{key:"keyFrameRefactor",value:function(e){for(var a=[],b=0;b<e.keyFrames.length;b++){var c={};c.time=e.keyFrames[b].time*this.fps;e.keyFrames[b].pos&&this.putFlags.putPos&&(c.pos=e.keyFrames[b].pos);e.keyFrames[b].rot&&this.putFlags.putRot&&(c.rot=e.keyFrames[b].rot);e.keyFrames[b].scl&&this.putFlags.putScl&&(c.scl=e.keyFrames[b].scl);e.keyFrames[b].matrix&&(c.matrix=e.keyFrames[b].matrix,this.putFlags.putPos&&(c.pos=(new THREE.Vector3).setFromMatrixPosition(c.matrix)),this.putFlags.putRot&&
(c.rot=(new THREE.Quaternion).setFromRotationMatrix(c.matrix)),this.putFlags.putScl&&(c.scl=(new THREE.Vector3).setFromMatrixScale(c.matrix)));a.push(c)}return a}}]);return k}(),t=function e(){h(this,e);this.time=this.Frame=this.index=0;this.matrix=null};return function(){function e(a,b){h(this,e);this.debug=!1;this.manager=void 0!==a?a:new THREE.DefaultLoadingManager;this.texloader=void 0!==b?b:new THREE.TextureLoader;this.baseDir=this.url="";this._putMatLength=0;this._nowMat=null;this._tmpUvArray=
[];this._facesNormal=[];this._nowFrameName="";this.frameHierarchie=[];this.Hierarchies={};this.HieStack=[];this._currentObject={};this._currentFrame={};this.onLoad=this._data=null;this.IsUvYReverse=!0;this.Meshes=[];this.animations=[];this.animTicksPerSecond=30;this._currentAnimeFrames=this._currentAnime=this._currentGeo=null}n(e,[{key:"_setArgOption",value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(a){for(;b<a.length;b++)switch(b){case 0:this.url=a[b];break;case 1:this.options=
a[b]}void 0===this.options&&(this.options={})}}},{key:"load",value:function(a,b,c,d){var f=this;this._setArgOption(a);a=new THREE.FileLoader(this.manager);a.setResponseType("arraybuffer");a.load(this.url,function(a){f._parse(a,b)},c,d)}},{key:"fromResponsedData",value:function(a,b,c){this._setArgOption(b);this._parse(a,c)}},{key:"_readLine",value:function(a){for(var b=0;;){var c=-1,c=a.indexOf("//",b);-1===c&&(c=a.indexOf("#",b));if(-1<c&&2>c)c=-1,c=a.indexOf("\r\n",b),0<c?b=c+2:(c=a.indexOf("\r",
b),b=0<c?c+1:a.indexOf("\n",b)+1);else break}return a.substr(b)}},{key:"_readLine",value:function(a){for(var b=0;;){var c=-1,c=a.indexOf("//",b);-1===c&&(c=a.indexOf("#",b));if(-1<c&&2>c)c=-1,c=a.indexOf("\r\n",b),0<c?b=c+2:(c=a.indexOf("\r",b),b=0<c?c+1:a.indexOf("\n",b)+1);else break}return a.substr(b)}},{key:"_isBinary",value:function(a){a=new DataView(a);if(84+50*a.getUint32(80,!0)===a.byteLength)return!0;for(var b=a.byteLength,c=0;c<b;c++)if(127<a.getUint8(c,!1))return!0;return!1}},{key:"ensureBinary",
value:function(a){if("string"===typeof a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c)&255;return b.buffer||b}return a}},{key:"ensureString",value:function(a){return"string"!==typeof a?THREE.LoaderUtils.decodeText(new Uint8Array(a)):a}},{key:"_parse",value:function(a,b){var c=this.ensureBinary(a);this._data=this.ensureString(a);this.onLoad=b;return this._isBinary(c)?this._parseBinary(c):this._parseASCII()}},{key:"_parseBinary",value:function(a){return this._parseASCII(THREE.LoaderUtils.decodeText(new Uint8Array(a)))}},
{key:"_parseASCII",value:function(){0<this.url.lastIndexOf("/")&&(this.baseDir=this.url.substr(0,this.url.lastIndexOf("/")+1));this.Hierarchies.children=[];this._hierarchieParse(this.Hierarchies,16);this._changeRoot();this._currentObject=this.Hierarchies.children.shift();this.mainloop()}},{key:"_hierarchieParse",value:function(a,b){for(var c=b;;){var d=this._data.indexOf("{",c)+1,f=this._data.indexOf("}",c),m=this._data.indexOf("{",d)+1;if(0<d&&f>d){var g={children:[]},c=this._readLine(this._data.substr(c,
d-c-1)).trim(),e=c.split(/ /g);0<e.length?(g.type=e[0],g.name=2<=e.length?e[1]:e[0]+this.Hierarchies.children.length):(g.name=c,g.type="");"Animation"===g.type?(g.data=this._data.substr(m,f-m).trim(),d=this._hierarchieParse(g,f+1),c=d.end,g.children=d.parent.children):(c=this._data.lastIndexOf(";",0<m?Math.min(m,f):f),g.data=this._data.substr(d,c-d).trim(),0>=m||f<m?c=f+1:(d=this._hierarchieParse(g,Math.max(c+1,d)),c=d.end,g.children=d.parent.children));g.parent=a;"template"!=g.type&&a.children.push(g)}else{c=
-1===d?this._data.length:f+1;break}}return{parent:a,end:c}}},{key:"mainloop",value:function(){var a=this;this.mainProc();this._currentObject.parent||0<this._currentObject.children.length||!this._currentObject.worked?setTimeout(function(){a.mainloop()},1):setTimeout(function(){a.onLoad({models:a.Meshes,animations:a.animations})},1)}},{key:"mainProc",value:function(){for(var a=!1;;){if(!this._currentObject.worked){switch(this._currentObject.type){case "AnimTicksPerSecond":this.animTicksPerSecond=parseInt(this._currentObject.data);
break;case "Frame":this._setFrame();break;case "FrameTransformMatrix":this._setFrameTransformMatrix();break;case "Mesh":this._changeRoot();this._currentGeo={};this._currentGeo.name=this._currentObject.name.trim();this._currentGeo.parentName=this._getParentName(this._currentObject).trim();this._currentGeo.VertexSetedBoneCount=[];this._currentGeo.Geometry=new THREE.Geometry;this._currentGeo.Materials=[];this._currentGeo.normalVectors=[];this._currentGeo.BoneInfs=[];this._currentGeo.baseFrame=this._currentFrame;
this._makeBoneFrom_CurrentFrame();this._readVertexDatas();a=!0;break;case "MeshNormals":this._readVertexDatas();break;case "MeshTextureCoords":this._setMeshTextureCoords();break;case "MeshMaterialList":this._setMeshMaterialList();break;case "Material":this._setMaterial();break;case "SkinWeights":this._setSkinWeights();break;case "AnimationSet":this._changeRoot();this._currentAnime={};this._currentAnime.name=this._currentObject.name.trim();this._currentAnime.AnimeFrames=[];break;case "Animation":this._currentAnimeFrames&&
this._currentAnime.AnimeFrames.push(this._currentAnimeFrames);this._currentAnimeFrames=new q;this._currentAnimeFrames.boneName=this._currentObject.data.trim();break;case "AnimationKey":this._readAnimationKey(),a=!0}this._currentObject.worked=!0}0<this._currentObject.children.length?(this._currentObject=this._currentObject.children.shift(),this.debug&&console.log("processing "+this._currentObject.name)):(this._currentObject.worked&&this._currentObject.parent&&!this._currentObject.parent.parent&&this._changeRoot(),
this._currentObject.parent?this._currentObject=this._currentObject.parent:a=!0);if(a)break}}},{key:"_changeRoot",value:function(){null!=this._currentGeo&&this._currentGeo.name&&this._makeOutputGeometry();this._currentGeo={};null!=this._currentAnime&&this._currentAnime.name&&(this._currentAnimeFrames&&(this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=null),this._makeOutputAnimation());this._currentAnime={}}},{key:"_getParentName",value:function(a){return a.parent?
a.parent.name?a.parent.name:this._getParentName(a.parent):""}},{key:"_setFrame",value:function(){this._nowFrameName=this._currentObject.name.trim();this._currentFrame={};this._currentFrame.name=this._nowFrameName;this._currentFrame.children=[];this._currentObject.parent&&this._currentObject.parent.name&&(this._currentFrame.parentName=this._currentObject.parent.name);this.frameHierarchie.push(this._nowFrameName);this.HieStack[this._nowFrameName]=this._currentFrame}},{key:"_setFrameTransformMatrix",
value:function(){this._currentFrame.FrameTransformMatrix=new THREE.Matrix4;var a=this._currentObject.data.split(",");this._ParseMatrixData(this._currentFrame.FrameTransformMatrix,a);this._makeBoneFrom_CurrentFrame()}},{key:"_makeBoneFrom_CurrentFrame",value:function(){if(this._currentFrame.FrameTransformMatrix){var a=new THREE.Bone;a.name=this._currentFrame.name;a.applyMatrix(this._currentFrame.FrameTransformMatrix);a.matrixWorld=a.matrix;a.FrameTransformMatrix=this._currentFrame.FrameTransformMatrix;
this._currentFrame.putBone=a;if(this._currentFrame.parentName)for(var b in this.HieStack)this.HieStack[b].name===this._currentFrame.parentName&&this.HieStack[b].putBone.add(this._currentFrame.putBone)}}},{key:"_readVertexDatas",value:function(){for(var a=0,b=0,c=0,d=0,f=0;;){var m=!1;if(0===c)a=this._readInt1(a).endRead,c=1,f=0,d=this._currentObject.data.indexOf(";;",a)+1,0>=d&&(d=this._currentObject.data.length);else{var e=0;switch(b){case 0:e=this._currentObject.data.indexOf(",",a)+1;break;case 1:e=
this._currentObject.data.indexOf(";,",a)+1}if(0===e||e>d)e=d,c=0,m=!0;switch(this._currentObject.type){case "Mesh":switch(b){case 0:this._readVertex1(this._currentObject.data.substr(a,e-a));break;case 1:this._readFace1(this._currentObject.data.substr(a,e-a))}break;case "MeshNormals":switch(b){case 0:this._readNormalVector1(this._currentObject.data.substr(a,e-a));break;case 1:this._readNormalFace1(this._currentObject.data.substr(a,e-a),f)}}a=e+1;f++;m&&b++}if(a>=this._currentObject.data.length)break}}},
{key:"_readInt1",value:function(a){var b=this._currentObject.data.indexOf(";",a);return{refI:parseInt(this._currentObject.data.substr(a,b-a)),endRead:b+1}}},{key:"_readVertex1",value:function(a){a=this._readLine(a.trim()).substr(0,a.length-2).split(";");this._currentGeo.Geometry.vertices.push(new THREE.Vector3(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2])));this._currentGeo.Geometry.skinIndices.push(new THREE.Vector4(0,0,0,0));this._currentGeo.Geometry.skinWeights.push(new THREE.Vector4(1,0,
0,0));this._currentGeo.VertexSetedBoneCount.push(0)}},{key:"_readFace1",value:function(a){a=this._readLine(a.trim()).substr(2,a.length-4).split(",");this._currentGeo.Geometry.faces.push(new THREE.Face3(parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10),(new THREE.Vector3(1,1,1)).normalize()))}},{key:"_readNormalVector1",value:function(a){a=this._readLine(a.trim()).substr(0,a.length-2).split(";");this._currentGeo.normalVectors.push(new THREE.Vector3(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2])))}},
{key:"_readNormalFace1",value:function(a,b){var c=this._readLine(a.trim()).substr(2,a.length-4).split(","),d=parseInt(c[0],10),f=this._currentGeo.normalVectors[d],d=parseInt(c[1],10),e=this._currentGeo.normalVectors[d],d=parseInt(c[2],10);this._currentGeo.Geometry.faces[b].vertexNormals=[f,e,this._currentGeo.normalVectors[d]]}},{key:"_setMeshNormals",value:function(){for(var a=0,b=0,c=0;;){switch(b){case 0:if(0===c)a=this._readInt1(0).endRead,c=1;else{var d=this._currentObject.data.indexOf(",",a)+
1;-1===d&&(d=this._currentObject.data.indexOf(";;",a)+1,b=2,c=0);a=this._currentObject.data.substr(a,d-a);a=this._readLine(a.trim()).split(";");this._currentGeo.normalVectors.push([parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2])]);a=d+1}}if(a>=this._currentObject.data.length)break}}},{key:"_setMeshTextureCoords",value:function(){this._tmpUvArray=[];this._currentGeo.Geometry.faceVertexUvs=[];this._currentGeo.Geometry.faceVertexUvs.push([]);for(var a=0,b=0,c=0;;){switch(b){case 0:if(0===c)a=this._readInt1(0).endRead,
c=1;else{var d=this._currentObject.data.indexOf(",",a)+1;0===d&&(d=this._currentObject.data.length,b=2,c=0);a=this._currentObject.data.substr(a,d-a);a=this._readLine(a.trim()).split(";");this.IsUvYReverse?this._tmpUvArray.push(new THREE.Vector2(parseFloat(a[0]),1-parseFloat(a[1]))):this._tmpUvArray.push(new THREE.Vector2(parseFloat(a[0]),parseFloat(a[1])));a=d+1}}if(a>=this._currentObject.data.length)break}this._currentGeo.Geometry.faceVertexUvs[0]=[];for(b=0;b<this._currentGeo.Geometry.faces.length;b++)this._currentGeo.Geometry.faceVertexUvs[0][b]=
[],this._currentGeo.Geometry.faceVertexUvs[0][b].push(this._tmpUvArray[this._currentGeo.Geometry.faces[b].a]),this._currentGeo.Geometry.faceVertexUvs[0][b].push(this._tmpUvArray[this._currentGeo.Geometry.faces[b].b]),this._currentGeo.Geometry.faceVertexUvs[0][b].push(this._tmpUvArray[this._currentGeo.Geometry.faces[b].c]);this._currentGeo.Geometry.uvsNeedUpdate=!0}},{key:"_setMeshMaterialList",value:function(){for(var a=0,b=0,c=0;;){if(2>c)a=this._readInt1(a).endRead,c++;else{var d=this._currentObject.data.indexOf(";",
a);-1===d&&(d=this._currentObject.data.length,b=3,c=0);a=this._currentObject.data.substr(a,d-a);a=this._readLine(a.trim()).split(",");for(d=0;d<a.length;d++)this._currentGeo.Geometry.faces[d].materialIndex=parseInt(a[d]);a=this._currentObject.data.length}if(a>=this._currentObject.data.length||3<=b)break}}},{key:"_setMaterial",value:function(){var a=new THREE.MeshPhongMaterial({color:16777215*Math.random()});a.side=THREE.FrontSide;a.name=this._currentObject.name;var b=0,c=this._currentObject.data.indexOf(";;",
b),b=this._currentObject.data.substr(b,c-b),b=this._readLine(b.trim()).split(";");a.color.r=parseFloat(b[0]);a.color.g=parseFloat(b[1]);a.color.b=parseFloat(b[2]);b=c+2;c=this._currentObject.data.indexOf(";",b);b=this._currentObject.data.substr(b,c-b);a.shininess=parseFloat(this._readLine(b));b=c+1;c=this._currentObject.data.indexOf(";;",b);b=this._currentObject.data.substr(b,c-b);b=this._readLine(b.trim()).split(";");a.specular.r=parseFloat(b[0]);a.specular.g=parseFloat(b[1]);a.specular.b=parseFloat(b[2]);
b=c+2;c=this._currentObject.data.indexOf(";;",b);-1===c&&(c=this._currentObject.data.length);b=this._currentObject.data.substr(b,c-b);c=this._readLine(b.trim()).split(";");a.emissive.r=parseFloat(c[0]);a.emissive.g=parseFloat(c[1]);a.emissive.b=parseFloat(c[2]);for(c=null;;)if(0<this._currentObject.children.length)switch(c=this._currentObject.children.shift(),this.debug&&console.log("processing "+c.name),b=c.data.substr(1,c.data.length-2),c.type){case "TextureFilename":a.map=this.texloader.load(this.baseDir+
b);break;case "BumpMapFilename":a.bumpMap=this.texloader.load(this.baseDir+b);a.bumpScale=.05;break;case "NormalMapFilename":a.normalMap=this.texloader.load(this.baseDir+b);a.normalScale=new THREE.Vector2(2,2);break;case "EmissiveMapFilename":a.emissiveMap=this.texloader.load(this.baseDir+b);break;case "LightMapFilename":a.lightMap=this.texloader.load(this.baseDir+b)}else break;this._currentGeo.Materials.push(a)}},{key:"_setSkinWeights",value:function(){var a=new p,b=0,c=this._currentObject.data.indexOf(";",
b),d=this._currentObject.data.substr(b,c-b),b=c+1;a.boneName=d.substr(1,d.length-2);a.BoneIndex=this._currentGeo.BoneInfs.length;c=this._currentObject.data.indexOf(";",b);b=c+1;c=this._currentObject.data.indexOf(";",b);d=this._currentObject.data.substr(b,c-b);b=this._readLine(d.trim()).split(",");for(d=0;d<b.length;d++)a.Indeces.push(parseInt(b[d]));b=c+1;c=this._currentObject.data.indexOf(";",b);d=this._currentObject.data.substr(b,c-b);b=this._readLine(d.trim()).split(",");for(d=0;d<b.length;d++)a.Weights.push(parseFloat(b[d]));
b=c+1;c=this._currentObject.data.indexOf(";",b);0>=c&&(c=this._currentObject.data.length);d=this._currentObject.data.substr(b,c-b);c=this._readLine(d.trim()).split(",");a.OffsetMatrix=new THREE.Matrix4;this._ParseMatrixData(a.OffsetMatrix,c);this._currentGeo.BoneInfs.push(a)}},{key:"_makePutBoneList",value:function(a,b){var c=!1,d;for(d in this.HieStack)if(this.HieStack[d].name===a||c){var c=!0,f=new THREE.Bone;f.name=this.HieStack[d].name;f.applyMatrix(this.HieStack[d].FrameTransformMatrix);f.matrixWorld=
f.matrix;f.FrameTransformMatrix=this.HieStack[d].FrameTransformMatrix;f.pos=(new THREE.Vector3).setFromMatrixPosition(f.FrameTransformMatrix).toArray();f.rotq=(new THREE.Quaternion).setFromRotationMatrix(f.FrameTransformMatrix).toArray();f.scl=(new THREE.Vector3).setFromMatrixScale(f.FrameTransformMatrix).toArray();if(this.HieStack[d].parentName&&0<this.HieStack[d].parentName.length)for(var e=0;e<b.length;e++)if(this.HieStack[d].parentName===b[e].name){b[e].add(f);f.parent=e;break}b.push(f)}}},{key:"_makeOutputGeometry",
value:function(){this._currentGeo.Geometry.computeBoundingBox();this._currentGeo.Geometry.computeBoundingSphere();this._currentGeo.Geometry.verticesNeedUpdate=!0;this._currentGeo.Geometry.normalsNeedUpdate=!0;this._currentGeo.Geometry.colorsNeedUpdate=!0;this._currentGeo.Geometry.uvsNeedUpdate=!0;this._currentGeo.Geometry.groupsNeedUpdate=!0;var a=null;if(0<this._currentGeo.BoneInfs.length){a=[];this._makePutBoneList(this._currentGeo.baseFrame.parentName,a);for(var b=0;b<this._currentGeo.BoneInfs.length;b++){for(var c=
0,d=0;d<a.length;d++)if(a[d].name===this._currentGeo.BoneInfs[b].boneName){c=d;a[d].OffsetMatrix=new THREE.Matrix4;a[d].OffsetMatrix.copy(this._currentGeo.BoneInfs[b].OffsetMatrix);break}for(d=0;d<this._currentGeo.BoneInfs[b].Indeces.length;d++){var f=this._currentGeo.BoneInfs[b].Indeces[d],e=this._currentGeo.BoneInfs[b].Weights[d];switch(this._currentGeo.VertexSetedBoneCount[f]){case 0:this._currentGeo.Geometry.skinIndices[f].x=c;this._currentGeo.Geometry.skinWeights[f].x=e;break;case 1:this._currentGeo.Geometry.skinIndices[f].y=
c;this._currentGeo.Geometry.skinWeights[f].y=e;break;case 2:this._currentGeo.Geometry.skinIndices[f].z=c;this._currentGeo.Geometry.skinWeights[f].z=e;break;case 3:this._currentGeo.Geometry.skinIndices[f].w=c,this._currentGeo.Geometry.skinWeights[f].w=e}this._currentGeo.VertexSetedBoneCount[f]++;4<this._currentGeo.VertexSetedBoneCount[f]&&console.log("warn! over 4 bone weight! :"+f)}}for(b=0;b<this._currentGeo.Materials.length;b++)this._currentGeo.Materials[b].skinning=!0;b=[];for(c=0;c<a.length;c++)a[c].OffsetMatrix?
b.push(a[c].OffsetMatrix):b.push(new THREE.Matrix4);c=(new THREE.BufferGeometry).fromGeometry(this._currentGeo.Geometry);c.bones=a;a=new THREE.SkinnedMesh(c,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials);a.skeleton.boneInverses=b}else a=(new THREE.BufferGeometry).fromGeometry(this._currentGeo.Geometry),a=new THREE.Mesh(a,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials);a.name=this._currentGeo.name;b=new THREE.Matrix4;
if((c=this._currentGeo.baseFrame.putBone)&&c.parent){for(;;)if(c=c.parent)b.multiply(c.FrameTransformMatrix);else break;a.applyMatrix(b)}this.Meshes.push(a)}},{key:"_readAnimationKey",value:function(){for(var a=0,b=this._currentObject.data.indexOf(";",a),c=this._currentObject.data.substr(a,b-a),a=b+1,d=parseInt(this._readLine(c)),b=this._currentObject.data.indexOf(";",a),c=this._currentObject.data.substr(b+1),a=this._readLine(c.trim()).split(";;,"),b=0;b<a.length;b++){var f=a[b].split(";"),c=new t;
c.type=d;c.Frame=parseInt(f[0]);c.index=this._currentAnimeFrames.keyFrames.length;c.time=c.Frame;if(4!=d){for(var e=!1,g=0;g<this._currentAnimeFrames.keyFrames.length;g++)if(this._currentAnimeFrames.keyFrames[g].Frame===c.Frame){c=this._currentAnimeFrames.keyFrames[g];e=!0;break}f=f[2].split(",");switch(d){case 0:c.rot=new THREE.Quaternion(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]),-1*parseFloat(f[0]));break;case 1:c.scl=new THREE.Vector3(parseFloat(f[0]),parseFloat(f[1]),parseFloat(f[2]));
break;case 2:c.pos=new THREE.Vector3(parseFloat(f[0]),parseFloat(f[1]),parseFloat(f[2]))}e||this._currentAnimeFrames.keyFrames.push(c)}else c.matrix=new THREE.Matrix4,this._ParseMatrixData(c.matrix,f[2].split(",")),this._currentAnimeFrames.keyFrames.push(c)}}},{key:"_makeOutputAnimation",value:function(){var a=new r(this.options);a.fps=this.animTicksPerSecond;a.name=this._currentAnime.name;a.make(this._currentAnime.AnimeFrames);this.animations.push(a)}},{key:"assignAnimation",value:function(a,b,c){a||
(a=this.Meshes[0]);b||(b=this.animations[0]);if(!a||!b)return null;c={};c.fps=b.fps;c.name=b.name;c.length=b.length;c.hierarchy=[];for(var d=0;d<a.skeleton.bones.length;d++){for(var f=!1,e=0;e<b.hierarchy.length;e++)if(a.skeleton.bones[d].name===b.hierarchy[e].name){f=!0;e=b.hierarchy[e].copy();e.parent=-1;if(a.skeleton.bones[d].parent&&"Bone"===a.skeleton.bones[d].parent.type)for(var g=0;g<c.hierarchy.length;g++)c.hierarchy[g].name===a.skeleton.bones[d].parent.name&&(e.parent=g,e.parentName=a.skeleton.bones[d].parent.name);
c.hierarchy.push(e);break}if(!f){f=b.hierarchy[0].copy();f.name=a.skeleton.bones[d].name;f.parent=-1;for(e=0;e<f.keys.length;e++)f.keys[e].pos&&f.keys[e].pos.set(0,0,0),f.keys[e].scl&&f.keys[e].scl.set(1,1,1),f.keys[e].rot&&f.keys[e].rot.set(0,0,0,1);c.hierarchy.push(f)}}a.geometry.animations||(a.geometry.animations=[]);a.geometry.animations.push(THREE.AnimationClip.parseAnimation(c,a.skeleton.bones));a.animationMixer||(a.animationMixer=new THREE.AnimationMixer(a));return c}},{key:"_ParseMatrixData",
value:function(a,b){a.set(parseFloat(b[0]),parseFloat(b[4]),parseFloat(b[8]),parseFloat(b[12]),parseFloat(b[1]),parseFloat(b[5]),parseFloat(b[9]),parseFloat(b[13]),parseFloat(b[2]),parseFloat(b[6]),parseFloat(b[10]),parseFloat(b[14]),parseFloat(b[3]),parseFloat(b[7]),parseFloat(b[11]),parseFloat(b[15]))}}]);return e}()});