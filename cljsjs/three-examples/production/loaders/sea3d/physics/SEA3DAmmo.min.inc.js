SEA3D.AMMO={world:null,rigidBodies:[],rigidBodiesTarget:[],rigidBodiesEnabled:[],constraints:[],vehicles:[],vehiclesWheels:[],ACTIVE:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5,VERSION:.8,init:function(a,b,c){a=void 0!==a?a:-90.8;this.worldScale=void 0==b?1:b;this.broadphase=void 0==c?"bvt":c;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.collisionConfig=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfig);
switch(this.broadphase){case "bvt":this.broadphase=new Ammo.btDbvtBroadphase;break;case "sap":this.broadphase=new Ammo.btAxisSweep3(new Ammo.btVector3(-this.worldScale,-this.worldScale,-this.worldScale),new Ammo.btVector3(this.worldScale,this.worldScale,this.worldScale),4096);break;case "simple":this.broadphase=new Ammo.btSimpleBroadphase}this.world=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.broadphase,this.solver,this.collisionConfig);this.setGravity(a);console.log("THREE.AMMO "+this.VERSION)},
setGravity:function(a){this.gravity=a;this.world.setGravity(new Ammo.btVector3(0,a,0));return this},getGravity:function(){return this.gravity},setEnabledRigidBody:function(a,b){var c=this.rigidBodies.indexOf(a);if(this.rigidBodiesEnabled[c]!=b)return b?this.world.addRigidBody(a):this.world.removeRigidBody(a),this.rigidBodiesEnabled[c]=!0,this},getEnabledRigidBody:function(a){return this.rigidBodiesEnabled[this.rigidBodies.indexOf(a)]},addRigidBody:function(a,b,c){c=void 0!==c?c:!0;this.rigidBodies.push(a);
this.rigidBodiesTarget.push(b);this.rigidBodiesEnabled.push(!1);this.setEnabledRigidBody(a,c);return this},removeRigidBody:function(a,b){var c=this.rigidBodies.indexOf(a);this.setEnabledRigidBody(a,!1);this.rigidBodies.splice(c,1);this.rigidBodiesTarget.splice(c,1);this.rigidBodiesEnabled.splice(c,1);b&&Ammo.destroy(a);return this},containsRigidBody:function(a){return-1<this.rigidBodies.indexOf(a)},addConstraint:function(a,b){b=void 0==b?!0:b;this.constraints.push(a);this.world.addConstraint(a,b);
return this},removeConstraint:function(a,b){this.constraints.splice(this.constraints.indexOf(a),1);this.world.removeConstraint(a);b&&Ammo.destroy(a);return this},containsConstraint:function(a){return-1<this.constraints.indexOf(rb)},addVehicle:function(a,b){this.vehicles.push(a);this.vehiclesWheels.push(void 0!=b?b:[]);this.world.addAction(a);return this},removeVehicle:function(a,b){var c=this.vehicles.indexOf(a);this.vehicles.splice(c,1);this.vehiclesWheels.splice(c,1);this.world.removeAction(a);
b&&Ammo.destroy(a);return this},containsVehicle:function(a){return-1<this.vehicles.indexOf(a)},createTriangleMesh:function(a,b,c){b=void 0==b?-1:b;c=void 0==c?!1:c;var g=new Ammo.btTriangleMesh,h=new Ammo.btVector3(0,0,0),d=new Ammo.btVector3(0,0,0),f=new Ammo.btVector3(0,0,0),e=a.getAttribute("position").array,l=a.getIndex().array,k=0<=b?a.groups[b]:void 0;a=k?k.count:l.length;b=1/this.worldScale;for(k=k?k.start:0;k<a;k+=3){var m=3*l[k],n=3*l[k+1],p=3*l[k+2];h.setValue(e[m]*b,e[m+1]*b,e[m+2]*b);
d.setValue(e[n]*b,e[n+1]*b,e[n+2]*b);f.setValue(e[p]*b,e[p+1]*b,e[p+2]*b);g.addTriangle(h,d,f,c)}return g},createConvexHull:function(a,b){b=void 0==b?-1:b;var c=new Ammo.btConvexHullShape;new Ammo.btVector3(0,0,0);for(var g=a.getAttribute("position").array,h=a.getIndex().array,d=0<=b?a.groups[b]:void 0,f=d?d.count:h.length,e=1/this.worldScale,d=d?d.start:0;d<f;d+=3){var l=3*h[d],l=new Ammo.btVector3(g[l]*e,g[l+1]*e,g[l+2]*e);c.addPoint(l)}return c},getTargetByRigidBody:function(a){return this.rigidBodiesTarget[this.rigidBodies.indexOf(a)]},
getRigidBodyByTarget:function(a){return this.rigidBodies[this.rigidBodiesTarget.indexOf(a)]},getTransformFromMatrix:function(a){var b=new Ammo.btTransform,c=THREE.SEA3D.VECBUF.setFromMatrixPosition(a);b.setOrigin(new Ammo.btVector3(c.x,c.y,c.z));c=THREE.SEA3D.VECBUF.setFromMatrixScale(a);a.scale(c.set(1/c.x,1/c.y,1/c.z));a=(new THREE.Quaternion).setFromRotationMatrix(a);c=new Ammo.btQuaternion;c.setValue(a.x,a.y,a.z,a.w);b.setRotation(c);Ammo.destroy(c);return b},getMatrixFromTransform:function(a){var b=
new THREE.Vector3,c=new THREE.Quaternion,g=new THREE.Vector3(1,1,1);return function(a,d){d=d||new THREE.Matrix4;var f=a.getOrigin(),e=a.getRotation();b.set(f.x(),f.y(),f.z());c.set(e.x(),e.y(),e.z(),e.w());d.compose(b,c,g);return d}}(),updateTargetTransform:function(){var a=new THREE.Matrix4,b=new THREE.Vector3,c=new THREE.Quaternion,g=new THREE.Vector3(1,1,1);return function(h,d,f){var e=d.getOrigin();d=d.getRotation();f?(b.set(e.x(),e.y(),e.z()),c.set(d.x(),d.y(),d.z(),d.w()),a.compose(b,c,g),a.multiplyMatrices(a,
f),h.position.setFromMatrixPosition(a),h.quaternion.setFromRotationMatrix(a)):(h.position.set(e.x(),e.y(),e.z()),h.quaternion.set(d.x(),d.y(),d.z(),d.w()));return this}}(),update:function(a,b,c){this.world.stepSimulation(a,b||0,c||.06);for(a=0;a<this.vehicles.length;a++){c=this.vehicles[a];var g=c.getNumWheels(),h=this.vehiclesWheels[a];for(b=0;b<g;b++){c.updateWheelTransform(b,!0);var d=c.getWheelTransformWS(b),f=h[b];f&&this.updateTargetTransform(f,d,f.physics?f.physics.offset:null)}}for(a=0;a<
this.rigidBodies.length;a++)b=this.rigidBodies[a],(c=this.rigidBodiesTarget[a])&&b.isActive()&&this.updateTargetTransform(c,b.getWorldTransform(),c.physics?c.physics.offset:null);return this}};