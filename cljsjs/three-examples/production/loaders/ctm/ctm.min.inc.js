var CTM=CTM||{};"object"===typeof module&&(module.exports=CTM);CTM.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053};CTM.Flags={NORMALS:1};CTM.File=function(a){this.load(a)};CTM.File.prototype.load=function(a){this.header=new CTM.FileHeader(a);this.body=new CTM.FileBody(this.header);this.getReader().read(a,this.body)};
CTM.File.prototype.getReader=function(){var a;switch(this.header.compressionMethod){case CTM.CompressionMethod.RAW:a=new CTM.ReaderRAW;break;case CTM.CompressionMethod.MG1:a=new CTM.ReaderMG1;break;case CTM.CompressionMethod.MG2:a=new CTM.ReaderMG2}return a};
CTM.FileHeader=function(a){a.readInt32();this.fileFormat=a.readInt32();this.compressionMethod=a.readInt32();this.vertexCount=a.readInt32();this.triangleCount=a.readInt32();this.uvMapCount=a.readInt32();this.attrMapCount=a.readInt32();this.flags=a.readInt32();this.comment=a.readString()};CTM.FileHeader.prototype.hasNormals=function(){return this.flags&CTM.Flags.NORMALS};
CTM.FileBody=function(a){var b=3*a.triangleCount,c=3*a.vertexCount,d=a.hasNormals()?3*a.vertexCount:0,e=2*a.vertexCount,k=4*a.vertexCount,f=0,h=new ArrayBuffer(4*(b+c+d+e*a.uvMapCount+k*a.attrMapCount));this.indices=new Uint32Array(h,0,b);this.vertices=new Float32Array(h,4*b,c);a.hasNormals()&&(this.normals=new Float32Array(h,4*(b+c),d));if(a.uvMapCount)for(this.uvMaps=[],f=0;f<a.uvMapCount;++f)this.uvMaps[f]={uv:new Float32Array(h,4*(b+c+d+f*e),e)};if(a.attrMapCount)for(this.attrMaps=[],f=0;f<a.attrMapCount;++f)this.attrMaps[f]=
{attr:new Float32Array(h,4*(b+c+d+e*a.uvMapCount+f*k),k)}};
CTM.FileMG2Header=function(a){a.readInt32();this.vertexPrecision=a.readFloat32();this.normalPrecision=a.readFloat32();this.lowerBoundx=a.readFloat32();this.lowerBoundy=a.readFloat32();this.lowerBoundz=a.readFloat32();this.higherBoundx=a.readFloat32();this.higherBoundy=a.readFloat32();this.higherBoundz=a.readFloat32();this.divx=a.readInt32();this.divy=a.readInt32();this.divz=a.readInt32();this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx;this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy;
this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz};CTM.ReaderRAW=function(){};CTM.ReaderRAW.prototype.read=function(a,b){this.readIndices(a,b.indices);this.readVertices(a,b.vertices);b.normals&&this.readNormals(a,b.normals);b.uvMaps&&this.readUVMaps(a,b.uvMaps);b.attrMaps&&this.readAttrMaps(a,b.attrMaps)};CTM.ReaderRAW.prototype.readIndices=function(a,b){a.readInt32();a.readArrayInt32(b)};CTM.ReaderRAW.prototype.readVertices=function(a,b){a.readInt32();a.readArrayFloat32(b)};
CTM.ReaderRAW.prototype.readNormals=function(a,b){a.readInt32();a.readArrayFloat32(b)};CTM.ReaderRAW.prototype.readUVMaps=function(a,b){for(var c=0;c<b.length;++c)a.readInt32(),b[c].name=a.readString(),b[c].filename=a.readString(),a.readArrayFloat32(b[c].uv)};CTM.ReaderRAW.prototype.readAttrMaps=function(a,b){for(var c=0;c<b.length;++c)a.readInt32(),b[c].name=a.readString(),a.readArrayFloat32(b[c].attr)};CTM.ReaderMG1=function(){};
CTM.ReaderMG1.prototype.read=function(a,b){this.readIndices(a,b.indices);this.readVertices(a,b.vertices);b.normals&&this.readNormals(a,b.normals);b.uvMaps&&this.readUVMaps(a,b.uvMaps);b.attrMaps&&this.readAttrMaps(a,b.attrMaps)};CTM.ReaderMG1.prototype.readIndices=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b,3);LZMA.decompress(a,a,c,c.data.length);CTM.restoreIndices(b,b.length)};
CTM.ReaderMG1.prototype.readVertices=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b,1);LZMA.decompress(a,a,c,c.data.length)};CTM.ReaderMG1.prototype.readNormals=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b,3);LZMA.decompress(a,a,c,c.data.length)};
CTM.ReaderMG1.prototype.readUVMaps=function(a,b){for(var c=0;c<b.length;++c){a.readInt32();b[c].name=a.readString();b[c].filename=a.readString();a.readInt32();var d=new CTM.InterleavedStream(b[c].uv,2);LZMA.decompress(a,a,d,d.data.length)}};CTM.ReaderMG1.prototype.readAttrMaps=function(a,b){for(var c=0;c<b.length;++c){a.readInt32();b[c].name=a.readString();a.readInt32();var d=new CTM.InterleavedStream(b[c].attr,4);LZMA.decompress(a,a,d,d.data.length)}};CTM.ReaderMG2=function(){};
CTM.ReaderMG2.prototype.read=function(a,b){this.MG2Header=new CTM.FileMG2Header(a);this.readVertices(a,b.vertices);this.readIndices(a,b.indices);b.normals&&this.readNormals(a,b);b.uvMaps&&this.readUVMaps(a,b.uvMaps);b.attrMaps&&this.readAttrMaps(a,b.attrMaps)};CTM.ReaderMG2.prototype.readVertices=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b,3);LZMA.decompress(a,a,c,c.data.length);c=this.readGridIndices(a,b);CTM.restoreVertices(b,this.MG2Header,c,this.MG2Header.vertexPrecision)};
CTM.ReaderMG2.prototype.readGridIndices=function(a,b){a.readInt32();a.readInt32();var c=new Uint32Array(b.length/3),d=new CTM.InterleavedStream(c,1);LZMA.decompress(a,a,d,d.data.length);CTM.restoreGridIndices(c,c.length);return c};CTM.ReaderMG2.prototype.readIndices=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b,3);LZMA.decompress(a,a,c,c.data.length);CTM.restoreIndices(b,b.length)};
CTM.ReaderMG2.prototype.readNormals=function(a,b){a.readInt32();a.readInt32();var c=new CTM.InterleavedStream(b.normals,3);LZMA.decompress(a,a,c,c.data.length);c=CTM.calcSmoothNormals(b.indices,b.vertices);CTM.restoreNormals(b.normals,c,this.MG2Header.normalPrecision)};
CTM.ReaderMG2.prototype.readUVMaps=function(a,b){for(var c=0;c<b.length;++c){a.readInt32();b[c].name=a.readString();b[c].filename=a.readString();var d=a.readFloat32();a.readInt32();var e=new CTM.InterleavedStream(b[c].uv,2);LZMA.decompress(a,a,e,e.data.length);CTM.restoreMap(b[c].uv,2,d)}};
CTM.ReaderMG2.prototype.readAttrMaps=function(a,b){for(var c=0;c<b.length;++c){a.readInt32();b[c].name=a.readString();var d=a.readFloat32();a.readInt32();var e=new CTM.InterleavedStream(b[c].attr,4);LZMA.decompress(a,a,e,e.data.length);CTM.restoreMap(b[c].attr,4,d)}};CTM.restoreIndices=function(a,b){var c=3;0<b&&(a[2]+=a[0],a[1]+=a[0]);for(;c<b;c+=3)a[c]+=a[c-3],a[c+1]=a[c]===a[c-3]?a[c+1]+a[c-2]:a[c+1]+a[c],a[c+2]+=a[c]};CTM.restoreGridIndices=function(a,b){for(var c=1;c<b;++c)a[c]+=a[c-1]};
CTM.restoreVertices=function(a,b,c,d){for(var e,k,f,h,m,n=new Uint32Array(a.buffer,a.byteOffset,a.length),g=b.divx,p=g*b.divy,t=2147483647,l=0,r=0,q=0,u=c.length;r<u;q+=3)f=e=c[r++],m=~~(f/p),f-=~~(m*p),h=~~(f/g),f-=~~(h*g),k=n[q],e===t&&(k+=l),a[q]=b.lowerBoundx+f*b.sizex+d*k,a[q+1]=b.lowerBoundy+h*b.sizey+d*n[q+1],a[q+2]=b.lowerBoundz+m*b.sizez+d*n[q+2],t=e,l=k};
CTM.restoreNormals=function(a,b,c){for(var d,e,k,f,h,m,n=new Uint32Array(a.buffer,a.byteOffset,a.length),g=0,p=a.length;g<p;g+=3)d=n[g]*c,e=n[g+1],0===e?(a[g]=b[g]*d,a[g+1]=b[g+1]*d,a[g+2]=b[g+2]*d):(k=4>=e?1.5707963267948966*(n[g+2]-2):1.5707963267948966*(4*n[g+2]/e-2),e=1.5707963267948966*e*c,f=d*Math.sin(e),h=f*Math.cos(k),k=f*Math.sin(k),d*=Math.cos(e),f=b[g+1],e=b[g]-b[g+2],m=Math.sqrt(2*f*f+e*e),1E-20<m&&(e/=m,f/=m),a[g]=b[g]*d+(b[g+1]*f-b[g+2]*e)*k-f*h,a[g+1]=b[g+1]*d-(b[g+2]+b[g])*f*k+e*h,
a[g+2]=b[g+2]*d+(b[g]*e+b[g+1]*f)*k+f*h)};CTM.restoreMap=function(a,b,c){for(var d,e,k=new Uint32Array(a.buffer,a.byteOffset,a.length),f=0,h,m=a.length;f<b;++f)for(d=0,h=f;h<m;h+=b)e=k[h],d+=e&1?-(e+1>>1):e>>1,a[h]=d*c};
CTM.calcSmoothNormals=function(a,b){var c=new Float32Array(b.length),d,e,k,f,h,m,n,g,p,t,l,r;l=0;for(r=a.length;l<r;)d=3*a[l++],e=3*a[l++],k=3*a[l++],m=b[e]-b[d],g=b[k]-b[d],n=b[e+1]-b[d+1],p=b[k+1]-b[d+1],h=b[e+2]-b[d+2],t=b[k+2]-b[d+2],f=n*t-h*p,h=h*g-m*t,m=m*p-n*g,n=Math.sqrt(f*f+h*h+m*m),1E-10<n&&(f/=n,h/=n,m/=n),c[d]+=f,c[d+1]+=h,c[d+2]+=m,c[e]+=f,c[e+1]+=h,c[e+2]+=m,c[k]+=f,c[k+1]+=h,c[k+2]+=m;l=0;for(r=c.length;l<r;l+=3)n=Math.sqrt(c[l]*c[l]+c[l+1]*c[l+1]+c[l+2]*c[l+2]),1E-10<n&&(c[l]/=n,c[l+
1]/=n,c[l+2]/=n);return c};CTM.isLittleEndian=function(){var a=new ArrayBuffer(2),b=new Uint8Array(a),a=new Uint16Array(a);b[0]=1;return 1===a[0]}();CTM.InterleavedStream=function(a,b){this.data=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);this.offset=CTM.isLittleEndian?3:0;this.count=4*b;this.len=this.data.length};
CTM.InterleavedStream.prototype.writeByte=function(a){this.data[this.offset]=a;this.offset+=this.count;this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count&&(this.offset-=this.count+(CTM.isLittleEndian?1:-1)))};CTM.Stream=function(a){this.data=a;this.offset=0};CTM.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23);CTM.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126);CTM.Stream.prototype.readByte=function(){return this.data[this.offset++]&255};
CTM.Stream.prototype.readInt32=function(){var a=this.readByte(),a=a|this.readByte()<<8,a=a|this.readByte()<<16;return a|this.readByte()<<24};CTM.Stream.prototype.readFloat32=function(){var a=this.readByte(),a=a+(this.readByte()<<8),b=this.readByte(),c=this.readByte(),a=a+((b&127)<<16),b=(c&127)<<1|(b&128)>>>7,c=c&128?-1:1;return 255===b?0!==a?NaN:Infinity*c:0<b?c*(1+a*this.TWO_POW_MINUS23)*Math.pow(2,b-127):0!==a?c*a*this.TWO_POW_MINUS126:0*c};
CTM.Stream.prototype.readString=function(){var a=this.readInt32();this.offset+=a;return String.fromCharCode.apply(null,this.data.subarray(this.offset-a,this.offset))};CTM.Stream.prototype.readArrayInt32=function(a){for(var b=0,c=a.length;b<c;)a[b++]=this.readInt32();return a};CTM.Stream.prototype.readArrayFloat32=function(a){for(var b=0,c=a.length;b<c;)a[b++]=this.readFloat32();return a};