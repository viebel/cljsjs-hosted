THREE.MMDExporter=function(){function t(a){if(void 0===l){var d=(new MMDParser.CharsetEncoder).s2uTable;l={};for(var c=Object.keys(d),f=0,m=c.length;f<m;f++){var g=c[f],h=d[g],g=parseInt(g);l[h]=g}}d=[];f=0;for(m=a.length;f<m;f++){c=a.charCodeAt(f);h=l[c];if(void 0===h)throw"cannot convert charcode 0x"+c.toString(16);255<h&&d.push(h>>8&255);d.push(h&255)}return new Uint8Array(d)}function u(a){a=a.clone();a.pose();return a.skeleton.bones}var l;this.parseVpd=function(a,d,c){function f(a){1E-6>Math.abs(a)&&
(a=0);var e=a.toString();-1===e.indexOf(".")&&(e+=".");var e=e+"000000",b=e.indexOf(".");a=e.slice(0,b);e=e.slice(b+1,b+7);return a+"."+e}function m(a){for(var b=[],c=0,d=a.length;c<d;c++)b.push(f(a[c]));return b.join(",")}if(!0!==a.isSkinnedMesh)return console.warn("THREE.MMDExporter: parseVpd() requires SkinnedMesh instance."),null;a.updateMatrixWorld(!0);var g=a.skeleton.bones,h=u(a),l=new THREE.Vector3,r=new THREE.Quaternion,v=new THREE.Quaternion,p=new THREE.Matrix4,b=[];b.push("Vocaloid Pose Data file");
b.push("");b.push((""!==a.name?a.name.replace(/\s/g,"_"):"skin")+".osm;");b.push(g.length+";");b.push("");a=0;for(var w=g.length;a<w;a++){var n=g[a],k=h[a];!0===c&&void 0!==n.userData.ik&&void 0!==n.userData.ik.originalMatrix?p.fromArray(n.userData.ik.originalMatrix):p.copy(n.matrix);l.setFromMatrixPosition(p);r.setFromRotationMatrix(p);var q=l.sub(k.position).toArray(),k=v.copy(k.quaternion).conjugate().multiply(r).toArray();q[2]=-q[2];k[0]=-k[0];k[1]=-k[1];b.push("Bone"+a+"{"+n.name);b.push("  "+
m(q)+";");b.push("  "+m(k)+";");b.push("}");b.push("")}b.push("");c=b.join("\n");return!0===d?t(c):c}};