var DAMPING=.03,DRAG=1-DAMPING,MASS=.1,restDistance=25,xSegs=10,ySegs=10,clothFunction=plane(restDistance*xSegs,restDistance*ySegs),cloth=new Cloth(xSegs,ySegs),GRAVITY=981*1.4,gravity=(new THREE.Vector3(0,-GRAVITY,0)).multiplyScalar(MASS),TIMESTEP=.018,TIMESTEP_SQ=TIMESTEP*TIMESTEP,pins=[],wind=!0,windStrength=2,windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3,lastTime;
function plane(a,d){return function(c,b,g){return(g||new THREE.Vector3).set((c-.5)*a,(b+.5)*d,0)}}function Particle(a,d,c,b){this.position=clothFunction(a,d);this.previous=clothFunction(a,d);this.original=clothFunction(a,d);this.a=new THREE.Vector3(0,0,0);this.mass=b;this.invMass=1/b;this.tmp=new THREE.Vector3;this.tmp2=new THREE.Vector3}Particle.prototype.addForce=function(a){this.a.add(this.tmp2.copy(a).multiplyScalar(this.invMass))};
Particle.prototype.integrate=function(a){var d=this.tmp.subVectors(this.position,this.previous);d.multiplyScalar(DRAG).add(this.position);d.add(this.a.multiplyScalar(a));this.tmp=this.previous;this.previous=this.position;this.position=d;this.a.set(0,0,0)};var diff=new THREE.Vector3;function satisfyConstraints(a,d,c){diff.subVectors(d.position,a.position);var b=diff.length();0!==b&&(c=diff.multiplyScalar(1-c/b).multiplyScalar(.5),a.position.add(c),d.position.sub(c))}
function Cloth(a,d){function c(b,c){return b+c*(a+1)}a=a||10;d=d||10;this.w=a;this.h=d;var b=[],g=[],e,f;for(f=0;f<=d;f++)for(e=0;e<=a;e++)b.push(new Particle(e/a,f/d,0,MASS));for(f=0;f<d;f++)for(e=0;e<a;e++)g.push([b[c(e,f)],b[c(e,f+1)],restDistance]),g.push([b[c(e,f)],b[c(e+1,f)],restDistance]);e=a;for(f=0;f<d;f++)g.push([b[c(e,f)],b[c(e,f+1)],restDistance]);f=d;for(e=0;e<a;e++)g.push([b[c(e,f)],b[c(e+1,f)],restDistance]);this.particles=b;this.constraints=g;this.index=c}
function simulate(a){if(lastTime){var d,c,b;if(wind){var g=clothGeometry.faces,e;c=cloth.particles;a=0;for(d=g.length;a<d;a++)b=g[a],e=b.normal,tmpForce.copy(e).normalize().multiplyScalar(e.dot(windForce)),c[b.a].addForce(tmpForce),c[b.b].addForce(tmpForce),c[b.c].addForce(tmpForce)}c=cloth.particles;a=0;for(d=c.length;a<d;a++)b=c[a],b.addForce(gravity),b.integrate(TIMESTEP_SQ);c=cloth.constraints;d=c.length;for(a=0;a<d;a++)b=c[a],satisfyConstraints(b[0],b[1],b[2]);ballPosition.z=90*-Math.sin(Date.now()/
600);ballPosition.x=70*Math.cos(Date.now()/400);if(sphere.visible)for(c=cloth.particles,a=0,d=c.length;a<d;a++)b=c[a],b=b.position,diff.subVectors(b,ballPosition),diff.length()<ballSize&&(diff.normalize().multiplyScalar(ballSize),b.copy(ballPosition).add(diff));c=cloth.particles;a=0;for(d=c.length;a<d;a++)b=c[a],b=b.position,-250>b.y&&(b.y=-250);a=0;for(d=pins.length;a<d;a++)b=c[pins[a]],b.position.copy(b.original),b.previous.copy(b.original)}else lastTime=a};